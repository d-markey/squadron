<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<?xml-stylesheet type="text/xsl" href="../../../jgenhtml.xsl"?><coverage branch-rate="NaN" branches-covered="0" branches-valid="0" complexity="0" date="2025-09-28" filename="_worker_runner.dart" function-rate="NaN" functions-covered="0" functions-valid="0" line-rate="0.8943662" lines-covered="127" lines-valid="142" package="src/_impl/xplat" testname="lcov.info" version="1.6">
    <lines>
        <line number="1">
            <code>import 'dart:async';</code>
        </line>
        <line number="2">
            <code/>
        </line>
        <line number="3">
            <code>import 'package:logger/web.dart';</code>
        </line>
        <line number="4">
            <code/>
        </line>
        <line number="5">
            <code>import '../../exceptions/squadron_error.dart';</code>
        </line>
        <line number="6">
            <code>import '../../exceptions/squadron_exception.dart';</code>
        </line>
        <line number="7">
            <code>import '../../local_worker/local_worker.dart';</code>
        </line>
        <line number="8">
            <code>import '../../service_installer.dart';</code>
        </line>
        <line number="9">
            <code>import '../../tokens/_cancelation_token_ref.dart';</code>
        </line>
        <line number="10">
            <code>import '../../tokens/_squadron_cancelation_token.dart';</code>
        </line>
        <line number="11">
            <code>import '../../typedefs.dart';</code>
        </line>
        <line number="12">
            <code>import '../../worker/worker_channel.dart';</code>
        </line>
        <line number="13">
            <code>import '../../worker/worker_request.dart';</code>
        </line>
        <line number="14">
            <code>import '../../worker_service.dart';</code>
        </line>
        <line number="15">
            <code>import '_internal_logger.dart';</code>
        </line>
        <line number="16">
            <code/>
        </line>
        <line number="17">
            <code>class WorkerRunner {</code>
        </line>
        <line number="18">
            <code>  /// Constructs a new worker runner.</code>
        </line>
        <line hits="10" number="19">
            <code>  WorkerRunner(this._terminate);</code>
            <hit count="10" name="&lt;unnamed&gt;"/>
        </line>
        <line number="20">
            <code/>
        </line>
        <line number="21">
            <code>  void Function(WorkerRunner) _terminate;</code>
        </line>
        <line number="22">
            <code/>
        </line>
        <line number="23">
            <code>  final internalLogger = InternalLogger();</code>
        </line>
        <line number="24">
            <code/>
        </line>
        <line number="25">
            <code>  WorkerService? _service;</code>
        </line>
        <line number="26">
            <code>  OperationsMap? _operations;</code>
        </line>
        <line number="27">
            <code/>
        </line>
        <line number="28">
            <code>  final _cancelTokens = &lt;String, CancelationTokenReference&gt;{};</code>
        </line>
        <line number="29">
            <code/>
        </line>
        <line number="30">
            <code>  bool _terminationRequested = false;</code>
        </line>
        <line number="31">
            <code>  int _executing = 0;</code>
        </line>
        <line number="32">
            <code/>
        </line>
        <line number="33">
            <code>  final _streamCancelers = &lt;int, StreamCanceler&gt;{};</code>
        </line>
        <line number="34">
            <code>  int _streamId = 0;</code>
        </line>
        <line number="35">
            <code/>
        </line>
        <line number="36">
            <code>  void Function(OutputEvent)? _logForwarder;</code>
        </line>
        <line number="37">
            <code/>
        </line>
        <line number="38">
            <code>  /// Constructs a new worker runner for a [localWorker].</code>
        </line>
        <line hits="1" number="39">
            <code>  factory WorkerRunner.use(LocalWorker localWorker) {</code>
            <hit count="1" name="&lt;unnamed&gt;"/>
        </line>
        <line hits="1" number="40">
            <code>    final runner = WorkerRunner((r) {</code>
            <hit count="1" name="&lt;unnamed&gt;"/>
        </line>
        <line hits="0" number="41">
            <code>      r.internalLogger.t('Terminating local Worker');</code>
        </line>
        <line hits="0" number="42">
            <code>      r._service = null;</code>
        </line>
        <line hits="0" number="43">
            <code>      r._operations = null;</code>
        </line>
        <line number="44">
            <code>    });</code>
        </line>
        <line hits="1" number="45">
            <code>    runner._service = localWorker;</code>
            <hit count="1" name="&lt;unnamed&gt;"/>
        </line>
        <line hits="2" number="46">
            <code>    runner._operations = localWorker.operations;</code>
            <hit count="2" name="&lt;unnamed&gt;"/>
        </line>
        <line hits="1" number="47">
            <code>    runner._checkOperations();</code>
            <hit count="1" name="&lt;unnamed&gt;"/>
        </line>
        <line number="48">
            <code>    return runner;</code>
        </line>
        <line number="49">
            <code>  }</code>
        </line>
        <line number="50">
            <code/>
        </line>
        <line hits="10" number="51">
            <code>  void _checkOperations() {</code>
            <hit count="10" name="&lt;unnamed&gt;"/>
        </line>
        <line hits="60" number="52">
            <code>    final invalidKeys = _operations!.keys.where((k) =&gt; k &lt;= 0).toList();</code>
            <hit count="60" name="&lt;unnamed&gt;"/>
        </line>
        <line hits="10" number="53">
            <code>    if (invalidKeys.isNotEmpty) {</code>
            <hit count="10" name="&lt;unnamed&gt;"/>
        </line>
        <line hits="2" number="54">
            <code>      throw SquadronErrorImpl.create(</code>
            <hit count="2" name="&lt;unnamed&gt;"/>
        </line>
        <line hits="8" number="55">
            <code>        'Invalid command identifier${(invalidKeys.length &gt; 1) ? 's' : ''} in service operations map: ${invalidKeys.join(', ')}. Command ids must be positive.',</code>
            <hit count="8" name="&lt;unnamed&gt;"/>
        </line>
        <line number="56">
            <code>      );</code>
        </line>
        <line number="57">
            <code>    }</code>
        </line>
        <line number="58">
            <code>  }</code>
        </line>
        <line number="59">
            <code/>
        </line>
        <line number="60">
            <code>  /// Called by the platform worker upon startup, in response to a start</code>
        </line>
        <line number="61">
            <code>  /// [WorkerRequest]. [channelInfo] is an opaque object sent back from the</code>
        </line>
        <line number="62">
            <code>  /// platform worker to the Squadron [Worker] and used to communicate with the</code>
        </line>
        <line number="63">
            <code>  /// platform worker. Typically, [channelInfo] would be a [SendPort] (native)</code>
        </line>
        <line number="64">
            <code>  /// or a [MessagePort] (browser). [initializer] is called to build the</code>
        </line>
        <line number="65">
            <code>  /// [WorkerService] associated to the worker. The runner's [_service] map</code>
        </line>
        <line number="66">
            <code>  /// will be set with operations from the service.</code>
        </line>
        <line hits="10" number="67">
            <code>  Future&lt;void&gt; connect(WorkerRequest? startRequest, PlatformChannel channelInfo,</code>
            <hit count="10" name="&lt;unnamed&gt;"/>
        </line>
        <line number="68">
            <code>      WorkerInitializer initializer) async {</code>
        </line>
        <line number="69">
            <code>    WorkerChannel? channel;</code>
        </line>
        <line number="70">
            <code>    try {</code>
        </line>
        <line hits="20" number="71">
            <code>      startRequest?.unwrapInPlace(internalLogger);</code>
            <hit count="20" name="&lt;unnamed&gt;"/>
        </line>
        <line hits="10" number="72">
            <code>      channel = startRequest?.channel;</code>
            <hit count="10" name="&lt;unnamed&gt;"/>
        </line>
        <line number="73">
            <code/>
        </line>
        <line number="74">
            <code>      if (startRequest == null) {</code>
        </line>
        <line hits="2" number="75">
            <code>        throw SquadronErrorImpl.create('Missing connection request');</code>
            <hit count="2" name="&lt;unnamed&gt;"/>
        </line>
        <line number="76">
            <code>      } else if (channel == null) {</code>
        </line>
        <line hits="0" number="77">
            <code>        throw SquadronErrorImpl.create('Missing client for connection request');</code>
        </line>
        <line number="78">
            <code>      }</code>
        </line>
        <line number="79">
            <code/>
        </line>
        <line hits="10" number="80">
            <code>      if (_logForwarder == null) {</code>
            <hit count="10" name="&lt;unnamed&gt;"/>
        </line>
        <line hits="10" number="81">
            <code>        final logger = channel.log;</code>
            <hit count="10" name="&lt;unnamed&gt;"/>
        </line>
        <line hits="40" number="82">
            <code>        _logForwarder = (event) =&gt; logger(event.origin);</code>
            <hit count="40" name="&lt;unnamed&gt;"/>
        </line>
        <line hits="20" number="83">
            <code>        Logger.addOutputListener(_logForwarder!);</code>
            <hit count="20" name="&lt;unnamed&gt;"/>
        </line>
        <line number="84">
            <code>      }</code>
        </line>
        <line number="85">
            <code/>
        </line>
        <line hits="10" number="86">
            <code>      if (!startRequest.isConnection) {</code>
            <hit count="10" name="&lt;unnamed&gt;"/>
        </line>
        <line hits="0" number="87">
            <code>        throw SquadronErrorImpl.create('Connection request expected');</code>
        </line>
        <line hits="20" number="88">
            <code>      } else if (_service != null || _operations != null) {</code>
            <hit count="20" name="&lt;unnamed&gt;"/>
        </line>
        <line hits="0" number="89">
            <code>        throw SquadronErrorImpl.create('Already connected');</code>
        </line>
        <line number="90">
            <code>      }</code>
        </line>
        <line number="91">
            <code/>
        </line>
        <line hits="20" number="92">
            <code>      _service = await initializer(startRequest);</code>
            <hit count="20" name="&lt;unnamed&gt;"/>
        </line>
        <line hits="30" number="93">
            <code>      _operations = _service!.operations;</code>
            <hit count="30" name="&lt;unnamed&gt;"/>
        </line>
        <line hits="10" number="94">
            <code>      _checkOperations();</code>
            <hit count="10" name="&lt;unnamed&gt;"/>
        </line>
        <line number="95">
            <code/>
        </line>
        <line hits="10" number="96">
            <code>      channel.connect(channelInfo);</code>
            <hit count="10" name="&lt;unnamed&gt;"/>
        </line>
        <line number="97">
            <code/>
        </line>
        <line hits="20" number="98">
            <code>      if (_service is ServiceInstaller) {</code>
            <hit count="20" name="&lt;unnamed&gt;"/>
        </line>
        <line hits="4" number="99">
            <code>        _installCompleter = Completer()</code>
            <hit count="4" name="&lt;unnamed&gt;"/>
        </line>
        <line hits="4" number="100">
            <code>          ..complete((() async {</code>
            <hit count="4" name="&lt;unnamed&gt;"/>
        </line>
        <line number="101">
            <code>            try {</code>
        </line>
        <line hits="4" number="102">
            <code>              await (_service as ServiceInstaller).install();</code>
            <hit count="4" name="&lt;unnamed&gt;"/>
        </line>
        <line number="103">
            <code>            } catch (ex, st) {</code>
        </line>
        <line hits="4" number="104">
            <code>              internalLogger.e(() =&gt; 'Service installation failed: $ex');</code>
            <hit count="4" name="&lt;unnamed&gt;"/>
        </line>
        <line hits="1" number="105">
            <code>              channel?.error(ex, st);</code>
            <hit count="1" name="&lt;unnamed&gt;"/>
        </line>
        <line hits="1" number="106">
            <code>              channel?.closeStream();</code>
            <hit count="1" name="&lt;unnamed&gt;"/>
        </line>
        <line hits="2" number="107">
            <code>              _installError = SquadronException.from(ex, st);</code>
            <hit count="2" name="&lt;unnamed&gt;"/>
        </line>
        <line number="108">
            <code>            }</code>
        </line>
        <line hits="2" number="109">
            <code>          })());</code>
            <hit count="2" name="&lt;unnamed&gt;"/>
        </line>
        <line number="110">
            <code>      }</code>
        </line>
        <line number="111">
            <code>    } catch (ex, st) {</code>
        </line>
        <line hits="8" number="112">
            <code>      internalLogger.e(() =&gt; 'Connection failed: $ex');</code>
            <hit count="8" name="&lt;unnamed&gt;"/>
        </line>
        <line hits="2" number="113">
            <code>      channel?.error(ex, st);</code>
            <hit count="2" name="&lt;unnamed&gt;"/>
        </line>
        <line hits="2" number="114">
            <code>      _exit();</code>
            <hit count="2" name="&lt;unnamed&gt;"/>
        </line>
        <line number="115">
            <code>    }</code>
        </line>
        <line number="116">
            <code>  }</code>
        </line>
        <line number="117">
            <code/>
        </line>
        <line number="118">
            <code>  Completer&lt;void&gt;? _installCompleter;</code>
        </line>
        <line number="119">
            <code>  SquadronException? _installError;</code>
        </line>
        <line number="120">
            <code/>
        </line>
        <line number="121">
            <code>  /// [WorkerRequest] handler dispatching commands according to the</code>
        </line>
        <line number="122">
            <code>  /// [_service] map. Make sure this method doesn't throw.</code>
        </line>
        <line hits="10" number="123">
            <code>  void processRequest(WorkerRequest request) async {</code>
            <hit count="10" name="&lt;unnamed&gt;"/>
        </line>
        <line number="124">
            <code>    WorkerChannel? channel;</code>
        </line>
        <line number="125">
            <code>    try {</code>
        </line>
        <line hits="20" number="126">
            <code>      request.unwrapInPlace(internalLogger);</code>
            <hit count="20" name="&lt;unnamed&gt;"/>
        </line>
        <line hits="10" number="127">
            <code>      channel = request.channel;</code>
            <hit count="10" name="&lt;unnamed&gt;"/>
        </line>
        <line number="128">
            <code/>
        </line>
        <line hits="10" number="129">
            <code>      if (request.isTermination) {</code>
            <hit count="10" name="&lt;unnamed&gt;"/>
        </line>
        <line number="130">
            <code>        // terminate the worker</code>
        </line>
        <line hits="10" number="131">
            <code>        return _shutdown();</code>
            <hit count="10" name="&lt;unnamed&gt;"/>
        </line>
        <line number="132">
            <code>      }</code>
        </line>
        <line number="133">
            <code/>
        </line>
        <line number="134">
            <code>      // check installation result if necessary</code>
        </line>
        <line hits="12" number="135">
            <code>      final pendingInstallation = _installCompleter?.future;</code>
            <hit count="12" name="&lt;unnamed&gt;"/>
        </line>
        <line number="136">
            <code>      if (pendingInstallation != null) {</code>
        </line>
        <line number="137">
            <code>        await pendingInstallation;</code>
        </line>
        <line hits="2" number="138">
            <code>        _installCompleter = null;</code>
            <hit count="2" name="&lt;unnamed&gt;"/>
        </line>
        <line number="139">
            <code>      }</code>
        </line>
        <line number="140">
            <code/>
        </line>
        <line hits="10" number="141">
            <code>      if (_installError != null) {</code>
            <hit count="10" name="&lt;unnamed&gt;"/>
        </line>
        <line number="142">
            <code>        // service installation failed</code>
        </line>
        <line hits="1" number="143">
            <code>        throw _installError!;</code>
            <hit count="1" name="&lt;unnamed&gt;"/>
        </line>
        <line number="144">
            <code>      }</code>
        </line>
        <line number="145">
            <code/>
        </line>
        <line number="146">
            <code>      // ==== these requests do not send a response ====</code>
        </line>
        <line number="147">
            <code/>
        </line>
        <line hits="10" number="148">
            <code>      if (request.isTokenCancelation) {</code>
            <hit count="10" name="&lt;unnamed&gt;"/>
        </line>
        <line number="149">
            <code>        // cancel a token</code>
        </line>
        <line hits="2" number="150">
            <code>        final token = request.cancelToken!;</code>
            <hit count="2" name="&lt;unnamed&gt;"/>
        </line>
        <line hits="4" number="151">
            <code>        return _getTokenRef(token).update(token);</code>
            <hit count="4" name="&lt;unnamed&gt;"/>
        </line>
        <line hits="10" number="152">
            <code>      } else if (request.isStreamCancelation) {</code>
            <hit count="10" name="&lt;unnamed&gt;"/>
        </line>
        <line number="153">
            <code>        // cancel a stream</code>
        </line>
        <line hits="12" number="154">
            <code>        final canceler = _streamCancelers[request.streamId];</code>
            <hit count="12" name="&lt;unnamed&gt;"/>
        </line>
        <line hits="3" number="155">
            <code>        return canceler?.call();</code>
            <hit count="3" name="&lt;unnamed&gt;"/>
        </line>
        <line number="156">
            <code>      }</code>
        </line>
        <line number="157">
            <code/>
        </line>
        <line number="158">
            <code>      // make sure the worker is connected</code>
        </line>
        <line number="159">
            <code/>
        </line>
        <line hits="10" number="160">
            <code>      if (request.isConnection) {</code>
            <hit count="10" name="&lt;unnamed&gt;"/>
        </line>
        <line number="161">
            <code>        // connection requests are handled by connect().</code>
        </line>
        <line hits="0" number="162">
            <code>        throw SquadronErrorImpl.create(</code>
        </line>
        <line hits="0" number="163">
            <code>            'Unexpected connection request: $request');</code>
        </line>
        <line hits="10" number="164">
            <code>      } else if (_operations == null) {</code>
            <hit count="10" name="&lt;unnamed&gt;"/>
        </line>
        <line number="165">
            <code>        // commands are not available yet (maybe connect() wasn't called or awaited)</code>
        </line>
        <line hits="0" number="166">
            <code>        throw SquadronErrorImpl.create('Worker service is not ready');</code>
        </line>
        <line number="167">
            <code>      }</code>
        </line>
        <line number="168">
            <code/>
        </line>
        <line number="169">
            <code>      // ==== other requests require a client to send the response ====</code>
        </line>
        <line number="170">
            <code/>
        </line>
        <line number="171">
            <code>      if (channel == null) {</code>
        </line>
        <line hits="0" number="172">
            <code>        throw SquadronErrorImpl.create('Missing client for request: $request');</code>
        </line>
        <line number="173">
            <code>      }</code>
        </line>
        <line number="174">
            <code/>
        </line>
        <line hits="10" number="175">
            <code>      final token = request.cancelToken;</code>
            <hit count="10" name="&lt;unnamed&gt;"/>
        </line>
        <line hits="2" number="176">
            <code>      token?.throwIfCanceled();</code>
            <hit count="2" name="&lt;unnamed&gt;"/>
        </line>
        <line number="177">
            <code/>
        </line>
        <line number="178">
            <code>      // start monitoring execution</code>
        </line>
        <line hits="10" number="179">
            <code>      final tokenRef = _begin(request);</code>
            <hit count="10" name="&lt;unnamed&gt;"/>
        </line>
        <line number="180">
            <code>      try {</code>
        </line>
        <line number="181">
            <code>        // find the operation matching the request command</code>
        </line>
        <line hits="30" number="182">
            <code>        final cmd = request.command, op = _operations![cmd];</code>
            <hit count="30" name="&lt;unnamed&gt;"/>
        </line>
        <line number="183">
            <code>        if (op == null) {</code>
        </line>
        <line hits="2" number="184">
            <code>          throw SquadronErrorImpl.create('Unknown command: $cmd');</code>
            <hit count="2" name="&lt;unnamed&gt;"/>
        </line>
        <line number="185">
            <code>        }</code>
        </line>
        <line number="186">
            <code/>
        </line>
        <line number="187">
            <code>        // process</code>
        </line>
        <line hits="10" number="188">
            <code>        var result = op(request);</code>
            <hit count="10" name="&lt;unnamed&gt;"/>
        </line>
        <line hits="10" number="189">
            <code>        if (result is Future) {</code>
            <hit count="10" name="&lt;unnamed&gt;"/>
        </line>
        <line number="190">
            <code>          result = await result;</code>
        </line>
        <line number="191">
            <code>        }</code>
        </line>
        <line number="192">
            <code/>
        </line>
        <line hits="10" number="193">
            <code>        final reply = request.reply!;</code>
            <hit count="10" name="&lt;unnamed&gt;"/>
        </line>
        <line hits="16" number="194">
            <code>        if (result is Stream &amp;&amp; channel.canStream(result)) {</code>
            <hit count="16" name="&lt;unnamed&gt;"/>
        </line>
        <line number="195">
            <code>          // result is a stream: forward data to the client</code>
        </line>
        <line hits="5" number="196">
            <code>          final replyWithError = channel.error;</code>
            <hit count="5" name="&lt;unnamed&gt;"/>
        </line>
        <line hits="3" number="197">
            <code>          void $postError(Object exception, [StackTrace? stackTrace]) {</code>
            <hit count="3" name="&lt;unnamed&gt;"/>
        </line>
        <line hits="3" number="198">
            <code>            replyWithError(exception, stackTrace, cmd);</code>
            <hit count="3" name="&lt;unnamed&gt;"/>
        </line>
        <line number="199">
            <code>          }</code>
        </line>
        <line number="200">
            <code/>
        </line>
        <line hits="5" number="201">
            <code>          void post(data) {</code>
            <hit count="5" name="&lt;unnamed&gt;"/>
        </line>
        <line number="202">
            <code>            try {</code>
        </line>
        <line hits="5" number="203">
            <code>              reply(data);</code>
            <hit count="5" name="&lt;unnamed&gt;"/>
        </line>
        <line number="204">
            <code>            } catch (ex, st) {</code>
        </line>
        <line hits="0" number="205">
            <code>              $postError(ex, st);</code>
        </line>
        <line number="206">
            <code>            }</code>
        </line>
        <line number="207">
            <code>          }</code>
        </line>
        <line number="208">
            <code/>
        </line>
        <line hits="5" number="209">
            <code>          await _pipe(result, channel, post, $postError, token);</code>
            <hit count="5" name="&lt;unnamed&gt;"/>
        </line>
        <line number="210">
            <code>        } else {</code>
        </line>
        <line number="211">
            <code>          // result is a value: send to the client</code>
        </line>
        <line hits="10" number="212">
            <code>          reply(result);</code>
            <hit count="10" name="&lt;unnamed&gt;"/>
        </line>
        <line number="213">
            <code>        }</code>
        </line>
        <line number="214">
            <code>      } finally {</code>
        </line>
        <line number="215">
            <code>        // stop monitoring execution</code>
        </line>
        <line hits="10" number="216">
            <code>        _done(tokenRef);</code>
            <hit count="10" name="&lt;unnamed&gt;"/>
        </line>
        <line number="217">
            <code>      }</code>
        </line>
        <line number="218">
            <code>    } catch (ex, st) {</code>
        </line>
        <line number="219">
            <code>      if (channel != null) {</code>
        </line>
        <line hits="6" number="220">
            <code>        channel.error(ex, st, request.command);</code>
            <hit count="6" name="&lt;unnamed&gt;"/>
        </line>
        <line number="221">
            <code>      } else {</code>
        </line>
        <line hits="3" number="222">
            <code>        internalLogger.e('Unhandled error: $ex');</code>
            <hit count="3" name="&lt;unnamed&gt;"/>
        </line>
        <line number="223">
            <code>      }</code>
        </line>
        <line number="224">
            <code>    }</code>
        </line>
        <line number="225">
            <code>  }</code>
        </line>
        <line number="226">
            <code/>
        </line>
        <line hits="10" number="227">
            <code>  CancelationTokenReference _getTokenRef(SquadronCancelationToken? token) =&gt;</code>
            <hit count="10" name="&lt;unnamed&gt;"/>
        </line>
        <line number="228">
            <code>      (token == null)</code>
        </line>
        <line hits="10" number="229">
            <code>          ? CancelationTokenReference.noToken</code>
            <hit count="10" name="&lt;unnamed&gt;"/>
        </line>
        <line hits="4" number="230">
            <code>          : _cancelTokens.putIfAbsent(</code>
            <hit count="4" name="&lt;unnamed&gt;"/>
        </line>
        <line hits="8" number="231">
            <code>              token.id, () =&gt; CancelationTokenReference(token.id));</code>
            <hit count="8" name="&lt;unnamed&gt;"/>
        </line>
        <line number="232">
            <code/>
        </line>
        <line number="233">
            <code>  /// Starts monitoring execution of this [request]. If the request contains a</code>
        </line>
        <line number="234">
            <code>  /// cancelation token, it is overridden with a [CancelationTokenReference]</code>
        </line>
        <line number="235">
            <code>  /// and this reference is returned to the sender. Otherwise, returns</code>
        </line>
        <line number="236">
            <code>  /// [CancelationTokenReference.noToken].</code>
        </line>
        <line hits="10" number="237">
            <code>  CancelationTokenReference _begin(WorkerRequest request) {</code>
            <hit count="10" name="&lt;unnamed&gt;"/>
        </line>
        <line hits="20" number="238">
            <code>    _executing++;</code>
            <hit count="20" name="&lt;unnamed&gt;"/>
        </line>
        <line hits="20" number="239">
            <code>    final token = _getTokenRef(request.cancelToken);</code>
            <hit count="20" name="&lt;unnamed&gt;"/>
        </line>
        <line hits="10" number="240">
            <code>    token.usedBy(request);</code>
            <hit count="10" name="&lt;unnamed&gt;"/>
        </line>
        <line number="241">
            <code>    return token;</code>
        </line>
        <line number="242">
            <code>  }</code>
        </line>
        <line number="243">
            <code/>
        </line>
        <line number="244">
            <code>  /// Stops monitoring execution and releases the [tokenRef].</code>
        </line>
        <line hits="10" number="245">
            <code>  void _done(CancelationTokenReference tokenRef) {</code>
            <hit count="10" name="&lt;unnamed&gt;"/>
        </line>
        <line hits="10" number="246">
            <code>    tokenRef.release();</code>
            <hit count="10" name="&lt;unnamed&gt;"/>
        </line>
        <line hits="20" number="247">
            <code>    if (tokenRef.refCount == 0) {</code>
            <hit count="20" name="&lt;unnamed&gt;"/>
        </line>
        <line hits="6" number="248">
            <code>      _cancelTokens.remove(tokenRef.id);</code>
            <hit count="6" name="&lt;unnamed&gt;"/>
        </line>
        <line number="249">
            <code>    }</code>
        </line>
        <line hits="20" number="250">
            <code>    _executing--;</code>
            <hit count="20" name="&lt;unnamed&gt;"/>
        </line>
        <line hits="14" number="251">
            <code>    if (_terminationRequested &amp;&amp; _executing == 0) {</code>
            <hit count="14" name="&lt;unnamed&gt;"/>
        </line>
        <line hits="2" number="252">
            <code>      _unmount();</code>
            <hit count="2" name="&lt;unnamed&gt;"/>
        </line>
        <line number="253">
            <code>    }</code>
        </line>
        <line number="254">
            <code>  }</code>
        </line>
        <line number="255">
            <code/>
        </line>
        <line number="256">
            <code>  /// Forwards stream events to client.</code>
        </line>
        <line hits="5" number="257">
            <code>  Future&lt;void&gt; _pipe(</code>
            <hit count="5" name="&lt;unnamed&gt;"/>
        </line>
        <line number="258">
            <code>    Stream&lt;dynamic&gt; stream,</code>
        </line>
        <line number="259">
            <code>    WorkerChannel channel,</code>
        </line>
        <line number="260">
            <code>    void Function(dynamic) post,</code>
        </line>
        <line number="261">
            <code>    void Function(Object exception, [StackTrace? stackTrace]) postError,</code>
        </line>
        <line number="262">
            <code>    SquadronCancelationToken? token,</code>
        </line>
        <line number="263">
            <code>  ) {</code>
        </line>
        <line number="264">
            <code>    late final StreamSubscription subscription;</code>
        </line>
        <line hits="5" number="265">
            <code>    final done = Completer();</code>
            <hit count="5" name="&lt;unnamed&gt;"/>
        </line>
        <line number="266">
            <code/>
        </line>
        <line number="267">
            <code>    late final int streamId;</code>
        </line>
        <line number="268">
            <code/>
        </line>
        <line number="269">
            <code>    // send endOfStream to client</code>
        </line>
        <line hits="5" number="270">
            <code>    Future&lt;void&gt; onDone() async {</code>
            <hit count="5" name="&lt;unnamed&gt;"/>
        </line>
        <line hits="5" number="271">
            <code>      _unregisterStreamCanceler(streamId);</code>
            <hit count="5" name="&lt;unnamed&gt;"/>
        </line>
        <line hits="5" number="272">
            <code>      channel.closeStream();</code>
            <hit count="5" name="&lt;unnamed&gt;"/>
        </line>
        <line hits="5" number="273">
            <code>      await subscription.cancel();</code>
            <hit count="5" name="&lt;unnamed&gt;"/>
        </line>
        <line hits="5" number="274">
            <code>      done.complete();</code>
            <hit count="5" name="&lt;unnamed&gt;"/>
        </line>
        <line number="275">
            <code>    }</code>
        </line>
        <line number="276">
            <code/>
        </line>
        <line number="277">
            <code>    final bool Function() checkToken;</code>
        </line>
        <line number="278">
            <code>    if (token == null) {</code>
        </line>
        <line hits="5" number="279">
            <code>      checkToken = () =&gt; true;</code>
            <hit count="5" name="&lt;unnamed&gt;"/>
        </line>
        <line number="280">
            <code>    } else {</code>
        </line>
        <line hits="2" number="281">
            <code>      checkToken = () {</code>
            <hit count="2" name="&lt;unnamed&gt;"/>
        </line>
        <line hits="2" number="282">
            <code>        final ex = token.exception;</code>
            <hit count="2" name="&lt;unnamed&gt;"/>
        </line>
        <line number="283">
            <code>        if (ex != null) {</code>
        </line>
        <line hits="0" number="284">
            <code>          postError(ex);</code>
        </line>
        <line hits="0" number="285">
            <code>          onDone();</code>
        </line>
        <line number="286">
            <code>        }</code>
        </line>
        <line number="287">
            <code>        return (ex == null);</code>
        </line>
        <line number="288">
            <code>      };</code>
        </line>
        <line number="289">
            <code>    }</code>
        </line>
        <line number="290">
            <code/>
        </line>
        <line number="291">
            <code>    // register stream canceler callback and connect stream with client</code>
        </line>
        <line hits="5" number="292">
            <code>    streamId = _registerStreamCanceler(onDone);</code>
            <hit count="5" name="&lt;unnamed&gt;"/>
        </line>
        <line hits="5" number="293">
            <code>    post(streamId);</code>
            <hit count="5" name="&lt;unnamed&gt;"/>
        </line>
        <line hits="5" number="294">
            <code>    if (checkToken()) {</code>
            <hit count="5" name="&lt;unnamed&gt;"/>
        </line>
        <line number="295">
            <code>      // start forwarding messages to the client</code>
        </line>
        <line hits="5" number="296">
            <code>      subscription = stream.listen(</code>
            <hit count="5" name="&lt;unnamed&gt;"/>
        </line>
        <line hits="5" number="297">
            <code>        (data) {</code>
            <hit count="5" name="&lt;unnamed&gt;"/>
        </line>
        <line hits="10" number="298">
            <code>          if (checkToken()) post(data);</code>
            <hit count="10" name="&lt;unnamed&gt;"/>
        </line>
        <line number="299">
            <code>        },</code>
        </line>
        <line hits="3" number="300">
            <code>        onError: (ex, st) {</code>
            <hit count="3" name="&lt;unnamed&gt;"/>
        </line>
        <line hits="6" number="301">
            <code>          if (checkToken()) postError(ex, st);</code>
            <hit count="6" name="&lt;unnamed&gt;"/>
        </line>
        <line number="302">
            <code>        },</code>
        </line>
        <line number="303">
            <code>        onDone: onDone,</code>
        </line>
        <line number="304">
            <code>        cancelOnError: false,</code>
        </line>
        <line number="305">
            <code>      );</code>
        </line>
        <line number="306">
            <code>    }</code>
        </line>
        <line number="307">
            <code/>
        </line>
        <line hits="5" number="308">
            <code>    return done.future;</code>
            <hit count="5" name="&lt;unnamed&gt;"/>
        </line>
        <line number="309">
            <code>  }</code>
        </line>
        <line number="310">
            <code/>
        </line>
        <line number="311">
            <code>  /// Assigns a stream ID to the stream canceler callback and registers the</code>
        </line>
        <line number="312">
            <code>  /// callback.</code>
        </line>
        <line hits="5" number="313">
            <code>  int _registerStreamCanceler(StreamCanceler canceler) {</code>
            <hit count="5" name="&lt;unnamed&gt;"/>
        </line>
        <line hits="10" number="314">
            <code>    final streamId = ++_streamId;</code>
            <hit count="10" name="&lt;unnamed&gt;"/>
        </line>
        <line hits="10" number="315">
            <code>    _streamCancelers[streamId] = canceler;</code>
            <hit count="10" name="&lt;unnamed&gt;"/>
        </line>
        <line number="316">
            <code>    return streamId;</code>
        </line>
        <line number="317">
            <code>  }</code>
        </line>
        <line number="318">
            <code/>
        </line>
        <line number="319">
            <code>  /// Unregisters the stream canceled callback associated to the [streamId].</code>
        </line>
        <line hits="5" number="320">
            <code>  void _unregisterStreamCanceler(int streamId) {</code>
            <hit count="5" name="&lt;unnamed&gt;"/>
        </line>
        <line hits="10" number="321">
            <code>    _streamCancelers.remove(streamId);</code>
            <hit count="10" name="&lt;unnamed&gt;"/>
        </line>
        <line number="322">
            <code>  }</code>
        </line>
        <line number="323">
            <code/>
        </line>
        <line number="324">
            <code>  /// Terminates the worker if there is no pending execution. Otherwise, marks</code>
        </line>
        <line number="325">
            <code>  /// the worker as terminating and termination will be effective when all</code>
        </line>
        <line number="326">
            <code>  /// pending executions have completed.</code>
        </line>
        <line hits="10" number="327">
            <code>  void _shutdown() {</code>
            <hit count="10" name="&lt;unnamed&gt;"/>
        </line>
        <line hits="10" number="328">
            <code>    _terminationRequested = true;</code>
            <hit count="10" name="&lt;unnamed&gt;"/>
        </line>
        <line hits="20" number="329">
            <code>    if (_executing == 0) {</code>
            <hit count="20" name="&lt;unnamed&gt;"/>
        </line>
        <line hits="10" number="330">
            <code>      _unmount();</code>
            <hit count="10" name="&lt;unnamed&gt;"/>
        </line>
        <line number="331">
            <code>    }</code>
        </line>
        <line number="332">
            <code>  }</code>
        </line>
        <line number="333">
            <code/>
        </line>
        <line number="334">
            <code>  // should not throw</code>
        </line>
        <line hits="10" number="335">
            <code>  void _unmount() async {</code>
            <hit count="10" name="&lt;unnamed&gt;"/>
        </line>
        <line number="336">
            <code>    try {</code>
        </line>
        <line number="337">
            <code>      // uninstall the service if necessary</code>
        </line>
        <line hits="20" number="338">
            <code>      if (_service is ServiceInstaller) {</code>
            <hit count="20" name="&lt;unnamed&gt;"/>
        </line>
        <line number="339">
            <code>        // check installation result</code>
        </line>
        <line hits="2" number="340">
            <code>        final pendingInstallation = _installCompleter?.future;</code>
            <hit count="2" name="&lt;unnamed&gt;"/>
        </line>
        <line number="341">
            <code>        if (pendingInstallation != null) {</code>
        </line>
        <line number="342">
            <code>          await pendingInstallation;</code>
        </line>
        <line hits="0" number="343">
            <code>          _installCompleter = null;</code>
        </line>
        <line number="344">
            <code>        }</code>
        </line>
        <line hits="2" number="345">
            <code>        if (_installError == null) {</code>
            <hit count="2" name="&lt;unnamed&gt;"/>
        </line>
        <line number="346">
            <code>          // uninstall iif the service installed succesfuly</code>
        </line>
        <line hits="4" number="347">
            <code>          await (_service as ServiceInstaller).uninstall();</code>
            <hit count="4" name="&lt;unnamed&gt;"/>
        </line>
        <line number="348">
            <code>        }</code>
        </line>
        <line number="349">
            <code>      }</code>
        </line>
        <line number="350">
            <code>    } catch (ex) {</code>
        </line>
        <line hits="3" number="351">
            <code>      internalLogger.e('Service uninstallation failed with error: $ex');</code>
            <hit count="3" name="&lt;unnamed&gt;"/>
        </line>
        <line number="352">
            <code>    } finally {</code>
        </line>
        <line hits="10" number="353">
            <code>      _exit();</code>
            <hit count="10" name="&lt;unnamed&gt;"/>
        </line>
        <line number="354">
            <code>    }</code>
        </line>
        <line number="355">
            <code>  }</code>
        </line>
        <line number="356">
            <code/>
        </line>
        <line number="357">
            <code>  // should not throw</code>
        </line>
        <line hits="10" number="358">
            <code>  void _exit() {</code>
            <hit count="10" name="&lt;unnamed&gt;"/>
        </line>
        <line number="359">
            <code>    try {</code>
        </line>
        <line hits="20" number="360">
            <code>      _terminate(this);</code>
            <hit count="20" name="&lt;unnamed&gt;"/>
        </line>
        <line number="361">
            <code>    } catch (ex) {</code>
        </line>
        <line hits="0" number="362">
            <code>      internalLogger.e('Worker termination failed with error: $ex');</code>
        </line>
        <line number="363">
            <code>    }</code>
        </line>
        <line hits="10" number="364">
            <code>    if (_logForwarder != null) {</code>
            <hit count="10" name="&lt;unnamed&gt;"/>
        </line>
        <line hits="20" number="365">
            <code>      Logger.removeOutputListener(_logForwarder!);</code>
            <hit count="20" name="&lt;unnamed&gt;"/>
        </line>
        <line number="366">
            <code>    }</code>
        </line>
        <line number="367">
            <code>  }</code>
        </line>
        <line number="368">
            <code>}</code>
        </line>
    </lines>
    <config branch-coverage="true" description-file="false" function-coverage="true" genhtml_hi_limit="90" genhtml_med_limit="75" legend="false" no-sort="false" no-source="false" show-details="false"/>
    <base href="../../../"/>
    <base href="../../../"/>
</coverage>
